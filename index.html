<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8'>
	<title>sheet-music-player</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.css" />
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/e-editor.css">
</head>
<body>
	<div id="app">
		<form id="bellForm">
			<div class="control-box">
				<span>切换风格：</span>
				<select name="oscType" id="oscTypeSelect">
					<option value="sine">sine</option>
					<option value="square">square</option>
					<option value="triangle">triangle</option>
					<option value="sawtooth">sawtooth</option>
				</select>
				<span>切换曲谱：</span>
				<select name="sheetName" id="sheetNameSelect">
					<option value="default" selected>默认</option>
					<option value="zhe-yi-sheng-guan-yu-ni-de-feng-jing">这一生关于你的风景</option>
					<option value="duan-qiao-can-xue">断桥残雪</option>
				</select>
			</div>
			<div class="e-editor" id="sheetMusic">C4C4G4G4A4A4G4-F4 F4 F4 F4F4E4E4D4D4C4</div>
			<div class="control-box">
				<div style="margin-bottom: 3px;">
					<button id="backBtn" class="s-n" type="button">退格</button>
					<button id="clearBtn" class="s-n" type="button">清空</button>
				</div>
				<div id="input-sheet"></div>
			</div>
			<div class="control-box">
				<button type="submit">播放</button>
				<button id="stopBtn">停止</button>
			</div>
			<section class="comment">
				支持音名
				C0 C2...C8 <br> 
				D0 E1...B8 <br>
				升调支持写法 C#1 C♯1 <br>
				降调支持写法 D.1 D♭1 <br>
				间隔时间时长用“空格”或“-”计算
			</section>
		</form>
	</div>
	<script type="module">
		import { playAudio, stopAudio } from './js/piano.js'

		import EEditor from './js/e-editor.js'

		const $ = document.querySelector.bind(document)

		const bellForm = $('#bellForm')
		const sheetNameSelect = $('#sheetNameSelect')
		const stopBtn = $('#stopBtn')
		const backBtn = $('#backBtn')
		const clearBtn = $('#clearBtn')
		let sheetMusic = ''

		addPlayEvent()

		function addPlayEvent () {
			bellForm.addEventListener('submit', playEvent)
			sheetNameSelect.addEventListener('change', changeSheet)
			stopBtn.addEventListener('click', stopEvent)
			backBtn.addEventListener('click', backSpace)
			clearBtn.addEventListener('click', () => backSpace('clear'))

			changeSheet()
		}

		function changeSheet () {
			let selectedValue = sheetNameSelect.options[sheetNameSelect.selectedIndex].value
			requireSheet(selectedValue)
		}

		async function requireSheet (name) {
			try {
				if (!name) return
				$('#sheetMusic').innerHTML = ''
				
				let sheetData = await import(`./sheet/${name}.js`)
				$('#sheetMusic').innerText = sheetData.default.trim()

				EEditor.init('#sheetMusic')
			} catch (err) {
				alert(err)
			}
		}

		function backSpace (step) {
			let editor = $('#sheetMusic')
			console.log(step)
			if (!step) {
				let lastChild = editor.children[editor.children.length - 1]
				lastChild && editor.removeChild(lastChild)
			} else if (step === 'clear') {
				editor.innerHTML = ''
			}
		}

		function playEvent (ev) {
			sheetMusic = $('#sheetMusic').innerText

			let formData = new FormData(bellForm)
			let oscType = [...formData][0][1]

			playAudio(sheetMusic, oscType)

  		ev.preventDefault()
		}

		function stopEvent () {
			stopAudio()
		}

	</script>
</body>
</html>
